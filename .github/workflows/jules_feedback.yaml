name: Send Feedback to Jules

on:
  pull_request_review:
    types: [submitted]

jobs:
  send-feedback:
    runs-on: ubuntu-latest
    environment: default
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check and Send Feedback
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          FEEDBACK_USERS: ${{ vars.FEEDBACK_USERS }}
        with:
          # GITHUB_TOKEN is sufficient for reading PR details and comments
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const review = context.payload.review;
            const reviewer = context.payload.sender.login;
            const prBody = pr.body || "";

            // 1. Check if Jules PR
            // Look for pattern: "PR created automatically by Jules for task [ID](url) started by @user"
            const regex = /PR created automatically by Jules for task \[([0-9]+)\]\(.*\) started by @([\w-]+)/;
            const match = prBody.match(regex);

            if (!match) {
              console.log("Not a Jules PR. Skipping.");
              return;
            }

            const sessionId = match[1];
            const starter = match[2];

            console.log(`Jules Session ID: ${sessionId}`);
            console.log(`Starter: ${starter}`);
            console.log(`Reviewer: ${reviewer}`);

            // 2. Check if Reviewer is Starter
            if (reviewer === starter) {
              console.log("Reviewer is the starter. Skipping.");
              return;
            }

            // 3. Check Allowed Users (Hardcoded / Variable)
            // Use comma-separated list from vars.FEEDBACK_USERS
            const feedbackUsersString = process.env.FEEDBACK_USERS || "";
            const feedbackUsers = feedbackUsersString.split(',').map(u => u.trim()).filter(u => u.length > 0);

            if (feedbackUsers.length === 0) {
               console.log("No FEEDBACK_USERS configured. Skipping check (or failing if strict mode desired).");
               // For now, let's log and return to be safe, or we could fail.
               // Assuming we only want feedback from specific people:
               console.log("Skipping: FEEDBACK_USERS variable is empty.");
               return;
            }

            if (!feedbackUsers.includes(reviewer)) {
               console.log(`User ${reviewer} is not in the allowed FEEDBACK_USERS list.`);
               return;
            }

            console.log(`User ${reviewer} is authorized to provide feedback.`);

            // 4. Gather Feedback
            let feedback = "";
            if (review.body) {
              feedback += `Review Summary:\n${review.body}\n\n`;
            }

            // Fetch review comments (line comments) associated with this review
            try {
              const { data: comments } = await github.rest.pulls.listReviewComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                review_id: review.id
              });

              if (comments && comments.length > 0) {
                feedback += "Line Comments:\n";
                comments.forEach(c => {
                   feedback += `File: ${c.path}:${c.original_line || c.line}\n`;
                   feedback += `Comment: ${c.body}\n\n`;
                });
              }
            } catch (err) {
               console.log(`Warning: Failed to fetch review comments: ${err.message}`);
            }

            if (!feedback.trim()) {
               console.log("No feedback content found (empty review body and no comments).");
               return;
            }

            console.log("Sending feedback to Jules...");

            const julesApiKey = process.env.JULES_API_KEY;
            if (!julesApiKey) {
               core.setFailed("JULES_API_KEY secret is not set.");
               return;
            }

            const url = `https://jules.googleapis.com/v1alpha/sessions/${sessionId}:sendMessage`;
            const payload = {
               prompt: `Feedback from ${reviewer}:\n\n${feedback}`
            };

            // Use native fetch (available in Node 20 environment of actions/github-script@v7)
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Goog-Api-Key': julesApiKey
              },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              const errorText = await response.text();
              core.setFailed(`Jules API Error: ${response.status} ${response.statusText} - ${errorText}`);
              return;
            }

            console.log("Feedback successfully sent to Jules.");
